---
import { Icon } from "astro-icon/components";
import { isEmpty } from "lodash-es";
import { marked } from "marked";

import Layout from "../../../layouts/Layout.astro";
import type { Plugin } from "./type";
import { Image } from "astro:assets";

interface Props {
  plugin: Plugin;
}

export async function getStaticPaths() {
  const pluginsDataRequest = await fetch(
    "https://raw.githubusercontent.com/gephi/gephi-plugins/refs/heads/gh-pages/plugins/plugins.json",
  );

  if (pluginsDataRequest.ok) {
    const pluginsData = (await pluginsDataRequest.json()).plugins as Plugin[];
    return pluginsData.map((p) => ({ params: { id: p.id }, props: { plugin: p } }));
  }
  return [];
}

const { plugin } = Astro.props;

let readme = "";
try {
  readme = await marked(plugin.readme);
} catch (err) {
  console.log(`README.md markdown generation failed for plugin ${plugin.name}.`);
}
---

<Layout class="plugin-page">
  <header class="banner py-4">
    <div class="container">
      <div class="banner-top">
        <a class="text-white" href="/desktop">Gephi</a> > <a class="text-white" href="/desktop/plugins">Gephi plugins</a
        > > <a class="text-white" href={`/desktop/plugins?categories=${plugin.category}`}>{plugin.category} plugins</a>
      </div>

      <div class="banner-contents">
        <div class="banner-texts gap-3">
          <h1 class="fs-2">{plugin.name}</h1>

          <p class="fs-4">{plugin.short_description}</p>
          <p class="fs-5 opacity-75">last updated on {plugin.last_update}</p>
        </div>
        {
          !!plugin.images?.length && (
            <div class="banner-image">
              <img
                class="flex-shrink-0 bg-white"
                src={`https://raw.githubusercontent.com/gephi/gephi-plugins/refs/heads/gh-pages/plugins/${plugin.images[0].image}`}
                alt=""
              />
            </div>
          )
        }
      </div>
    </div>
  </header>

  <main class="pt-5">
    <section class="container pb-5 plugin-page">
      <div class="row">
        <div>
          <section class="mb-3">
            <h2 class="fs-4">
              <Icon name="ph:article" />
              Description:
            </h2>
            <div class="fs-5 plugin-description"><div set:html={plugin.long_description} /></div>
          </section>

          <section class="mb-3">
            <h2 class="fs-4">
              <Icon name={plugin.authors.length > 1 ? "ph:users" : "ph:user"} />
              {plugin.authors.length > 1 ? "Authors" : "Author"}:
            </h2>
            {
              plugin.authors?.length > 0 ? (
                <ul class="list-unstyled">
                  {plugin.authors.flatMap((author) => (
                    <li>
                      {author.email && [
                        <a class="text-decoration-none" href={`mailto:${author.email}`}>
                          <Icon name="ph:envelope" />
                        </a>,
                        " ",
                      ]}
                      {author.link && [
                        <a class="text-decoration-none" href={author.link}>
                          <Icon name="ph:link" />
                        </a>,
                        " ",
                      ]}
                      {author.name}
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="text-muted">No author specified.</div>
              )
            }
          </section>

          <section class="mb-3">
            <h2 class="fs-4">
              <Icon name="ph:code" /> Sources:
            </h2>
            {
              plugin.sourcecode ? (
                <a href={plugin.sourcecode}>{plugin.sourcecode.replace(/^https?:\/\//, "")}</a>
              ) : (
                <div class="text-muted">No link specified.</div>
              )
            }
          </section>

          <section class="mb-3">
            <h2 class="fs-4">
              <Icon name="ph:scales" /> License:
            </h2>
            {plugin.license ? <div>{plugin.license}</div> : <div class="text-muted">No link specified.</div>}
          </section>

          <section class="mb-3">
            <h2 class="fs-4">
              <Icon name="ph:tag" /> Compatible Gephi versions:
            </h2>
            <div class="alert alert-primary" role="alert">
              When possible, you should directly install this plugin from Gephi{" "}
              <strong>
                <pre class="d-inline">Tools > Plugins</pre>
              </strong>
              menu. The following download links may be useful to spread this plugin to people with no internet access, for
              instance.
            </div>
            {
              !isEmpty(plugin.versions) ? (
                <ul class="list-unstyled">
                  {Object.keys(plugin.versions)
                    .reverse()
                    .map((v) => (
                      <li>
                        <a href={plugin.versions[v].url} class="text-decoration-none">
                          <Icon name="ph:download" />
                          Download plugin for Gephi v{v}
                        </a>
                      </li>
                    ))}
                </ul>
              ) : (
                <div class="text-muted">No compatible version specified.</div>
              )
            }
          </section>
        </div>

        {
          plugin.images && plugin.images.length > 1 && (
            <section class="mb-4">
              <h2 class="fs-4">
                <Icon name="ph:image" /> Related images:
              </h2>
              <div class="thumbnails">
                {plugin.images.map(({ image }) => (
                  <a
                    href={`https://raw.githubusercontent.com/gephi/gephi-plugins/refs/heads/gh-pages/plugins/${image}`}
                    class=""
                  >
                    <img
                      class="border img-fluid"
                      src={`https://raw.githubusercontent.com/gephi/gephi-plugins/refs/heads/gh-pages/plugins/${image}`}
                    />
                  </a>
                ))}
              </div>
            </section>
          )
        }

        {
          readme && (
            <Fragment>
              <hr class="my-5" />

              <section id="readme">
                <h2 class="fs-4">
                  <a class="text-decoration-none" href="#readme">
                    <Icon name="ph:hash" />
                  </a>{" "}
                  README:
                </h2>

                <div set:html={readme} class="plugin-readme" />
              </section>
            </Fragment>
          )
        }
      </div>
    </section>
  </main>
</Layout>
